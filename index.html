<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monopoly Controller</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 16px; background: #0b2b3a; color: #eef6fb; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0; }
    button { padding: 12px 16px; font-size: 16px; border-radius: 8px; border: 1px solid #d9eef7; background: #164b63; color: #fff; cursor: pointer; }
    button:active { transform: translateY(1px); }
    input, select { padding: 10px 12px; font-size: 16px; border-radius: 8px; border: 1px solid #79b8d1; background: #0f3a4c; color: #fff; }
    .status { margin-top: 12px; font-size: 14px; opacity: 0.9; }
    .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 13px; padding: 2px 6px; border-radius: 6px; background: #0f3a4c; border: 1px solid #2f6880; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(100px,1fr)); gap: 10px; max-width: 360px; }
  </style>
</head>
<body>
  <h1>Monopoly Controller</h1>

  <div class="row">
    <label>Speler ID (1..6):
      <input id="pid" type="number" min="1" max="6" value="1" />
    </label>
    <label>Server:
      <select id="server">
        <option value="wss://felipe-stoical-paradoxically.ngrok-free.dev">wss://felipe-stoical-paradoxically.ngrok-free.dev</option>
      </select>
    </label>
    <button id="connect">Verbinden</button>
    <button id="disconnect">Verbreken</button>
  </div>

  <div class="row">
    <button id="btnA">A (Gooien)</button>
    <button id="btnStart">Start (Gooien)</button>
    <button id="btnX">X (Koop)</button>
    <button id="btnY">Y (Veil)</button>
  </div>

  <div class="row">
    <div class="grid">
      <button id="up">↑</button>
      <button id="down">↓</button>
      <button id="left">←</button>
      <button id="right">→</button>
      <button id="b">B</button>
      <button id="select">Select</button>
    </div>
  </div>

  <div class="status">
    Status: <span id="status">Niet verbonden</span><br />
    Tip: Tik kort op A/Start om te gooien. X = koop, Y = veilen. Houd geen knoppen ingedrukt om herhaalde acties te voorkomen.
  </div>

  <script>
    // Config
    const wsSelect = document.getElementById('server');
    const pidInput = document.getElementById('pid');
    const statusEl = document.getElementById('status');

    let ws = null;
    let pressed = {
      up:0, down:0, left:0, right:0,
      a:0, b:0, x:0, y:0, start:0, select:0,
      lx:0.0, ly:0.0, rx:0.0, ry:0.0
    };
    let sendTimer = null;

    function logStatus(txt, ok=true) {
      statusEl.textContent = txt;
      statusEl.style.color = ok ? '#a7f3d0' : '#fca5a5';
    }

    function connect() {
      const url = wsSelect.value.trim();
      try {
        ws = new WebSocket(url);
      } catch (e) {
        logStatus('WS fout bij openen', false);
        return;
      }
      ws.onopen = () => {
        logStatus('Verbonden met ' + url);
        startSender();
      };
      ws.onmessage = (ev) => {
        // optioneel: handshake
        // console.log('msg', ev.data);
      };
      ws.onclose = () => {
        logStatus('Verbinding gesloten', false);
        stopSender();
        ws = null;
      };
      ws.onerror = () => {
        logStatus('WS fout', false);
      };
    }

    function disconnect() {
      if (ws) {
        try { ws.close(); } catch (e) {}
        ws = null;
      }
      stopSender();
      logStatus('Niet verbonden', false);
    }

    function startSender() {
      if (sendTimer) return;
      sendTimer = setInterval(() => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        const pid = Math.max(1, Math.min(6, parseInt(pidInput.value || '1', 10)));
        const payload = { id: pid, ...pressed };
        try {
          ws.send(JSON.stringify(payload));
        } catch (e) {
          // noop
        }
      }, 50); // 20 Hz
    }

    function stopSender() {
      if (sendTimer) { clearInterval(sendTimer); sendTimer = null; }
    }

    function bindPress(id, key) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('touchstart', (e) => { e.preventDefault(); pressed[key]=1; }, {passive:false});
      el.addEventListener('touchend',   (e) => { e.preventDefault(); pressed[key]=0; }, {passive:false});
      el.addEventListener('mousedown',  (e) => { e.preventDefault(); pressed[key]=1; });
      el.addEventListener('mouseup',    (e) => { e.preventDefault(); pressed[key]=0; });
      el.addEventListener('mouseleave', (e) => { e.preventDefault(); pressed[key]=0; });
    }

    // Buttons
    document.getElementById('connect').addEventListener('click', connect);
    document.getElementById('disconnect').addEventListener('click', disconnect);

    bindPress('btnA','a');
    bindPress('btnStart','start');
    bindPress('btnX','x');
    bindPress('btnY','y');
    bindPress('up','up');
    bindPress('down','down');
    bindPress('left','left');
    bindPress('right','right');
    bindPress('b','b');
    bindPress('select','select');

    // Waarschuwing bij weggaan
    window.addEventListener('beforeunload', () => {
      try { if (ws) ws.close(); } catch (e) {}
    });
  </script>
</body>
</html>
